/*
	 Generate MC sample and fit to model using Minuit.

	 Weiran, Nov.17, 2018.
*/

#include "../../Simulation/Simulation.h"

Simulation sim;
TMinuit minuit;

double pmass = 0.35*0.35;
double pendpoint = 18574;

TH1D* sample;
TH1D* theory;

void fcn(int &npar, double* gin, double &f, double* par, int iflag);

void Fit()
{
	/* Generate MC sample. */
	sample = sim.Generate(pmass, pendpoint);

	minuit.DefineParameter(0, "mass", pmass, 0.001, 0, 1e4);
	minuit.DefineParameter(1, "endpoint", pendpoint, 0.01, pendpoint-5, pendpoint+5);
	minuit.DefineParameter(2, "A_sig", 1, 0.01, 0, 2);
	minuit.DefineParameter(3, "A_bkg", 1, 0.01, 0, 2);
	minuit.SetFCN(fcn);
	minuit.SetErrorDef(1);
	minuit.Migrad();

}

void fcn(int &npar, double* gin, double &f, double* par, int iflag) {
	delete theory;
	theory = sim.Asimov(par[0], par[1], par[2], par[3]);
	double chi2 = 0;
	for(int bin=1; bin<=theory->GetNbinsX(); bin++) {
		double pred = theory->GetBinContent(bin);
		double meas = sample->GetBinContent(bin);
		double error = sample->GetBinError(bin);
		chi2 += pow((pred-meas)/error, 2);
	}
	f = chi2;
}

